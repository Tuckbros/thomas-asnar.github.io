<html lang=fr">
<head>
<meta charset="utf-8" />
</head>
<body>

<button id="refresh-button">Refresh</button>
<table id="list-jobs"></table>

<script>
// Variables Globales
var serveurVtom = "http://ip:30080" ;
var authVtom = "xxxxxxxxxxx" ; //base64 user:password
var itemsVtom = [ "environment", "application", "job", "date", "host", "queue" ] ; 
itemsVtom.forEach(function(item){
	eval("var API_" + item + "_LIST = null ;") ;
});


// Fonctions
function findItemById(source, id){
    return source.filter(function( obj ) {
        return obj.id == id;
    })[ 0 ];
}

function debutAffichage(){
	
	API_job_LIST.result.forEach(function(entry){
		var application = findItemById(API_application_LIST.result, entry.applicationSId) ;
		var environment = findItemById(API_environment_LIST.result, application.environmentSId) ;
		var host = findItemById(API_host_LIST.result, entry.host) ;
		if(!host){
			var host = findItemById(API_host_LIST.result, application.host) ;
			if(!host){
				var host = findItemById(API_host_LIST.result, environment.host) ;
			}
		}
		var dateVtom = findItemById(API_date_LIST.result, entry.date) ;
		if(!dateVtom){
			var dateVtom = findItemById(API_date_LIST.result, application.date) ;
			if(!dateVtom){
				var dateVtom = findItemById(API_date_LIST.result, environment.date) ;
			}
		}
		var queue = findItemById(API_queue_LIST.result, entry.queue) ;
		if(!queue){
			var queue = findItemById(API_queue_LIST.result, application.queue) ;
			if(!queue){
				var queue = findItemById(API_queue_LIST.result, environment.queue) ;
			}
		}
		
		var tableListJobs = document.querySelector('table#list-jobs') ;
		var this_tr = document.createElement("tr");
		this_tr.innerHTML = "<td>" + environment.name + "</td>" +
			"<td>" + application.name + "</td>" +
			"<td>" + entry.name + "</td>" +
			"<td>" + dateVtom.name + "</td>" +
			"<td>" + queue.name + "</td>" +
			"<td>" + host.name + "</td>" +
			"<td>" + entry.Script + "</td>" ;

		if(entry.Parameters){
			this_tr.innerHTML = this_tr.innerHTML + "<td>" ;
			entry.Parameters.forEach(function(parameter){
				this_tr.innerHTML = this_tr.innerHTML + parameter + "<br>" ;
			});
			this_tr.innerHTML = this_tr.innerHTML + "</td>" ;
		}

		tableListJobs.appendChild(this_tr);
	}); //eof foreach job list

} // eof debutAffichage

function getItemsVtom(){
	if(typeof(Storage) !== "undefined") {
		var isAllItemsInStorage = true ;
		itemsVtom.forEach(function(item){
			if(sessionStorage["API_"+item+"_LIST"]){
				eval('API_'+item+'_LIST = JSON.parse(sessionStorage.getItem("API_'+item+'_LIST")) ;') ;
			}else{
				isAllItemsInStorage = false ;
			}

		});
		if(! isAllItemsInStorage){
			getItemsVtomAPI() ;
		}

	}else{
		getItemsVtomAPI() ;
	}
} // eof getItemsVtom

function removeItemsFromSessionStorage(){
	itemsVtom.forEach(function(item){
		sessionStorage.removeItem("API_"+item+"_LIST");
	});
}

function getItemsVtomAPI(){
 itemsVtom.forEach(function(item){

	eval('var xhr'+item+' = new XMLHttpRequest();') ; 
	var strCode = 'xhr'+item+'.onreadystatechange = function(){' + 
	      'var status = xhr'+item+'.status;' +

	      'if (status == 200) {'+
		'if(xhr'+item+'.response != null) {' +
			'API_'+item+'_LIST = xhr'+item+'.response ;' +
			'if(typeof(Storage) !== "undefined") {' +
				'sessionStorage.setItem("API_'+item+'_LIST",JSON.stringify(API_'+item+'_LIST)) ;' +
			'}' +
		'}' + 
	      '}' +

	'}' ;
	eval(strCode);
	eval('xhr'+item+".open('GET', serveurVtom + '/api/"+item+"/getAll');") ;
	eval('xhr'+item+".responseType = 'json';") ;
	eval('xhr'+item+".setRequestHeader('Authorization', 'Basic ' + authVtom);");
	eval('xhr'+item+'.send();') ;
 });

} // eof getItemsVtomAPI



// Events

// On vérifie qu'on a bien chargé toutes les données, on affiche quand c'est ok
window.intervalDebutAffichage = setInterval(function(){

 console.log((new Date()).getTime());
 var isAllItemsLoaded = true ;
 itemsVtom.forEach(function(item){
	if(eval('API_'+item+'_LIST') == null){
		isAllItemsLoaded = false ;
	}
 });
 if( isAllItemsLoaded )
 { 
	clearInterval(window.intervalDebutAffichage);
	debutAffichage();
 }  }, 3000
); 

// on sort si on dépasse le timeout
setTimeout(function(){ clearInterval(window.intervalDebutAffichage) }, 60000);

// On récupère les items
getItemsVtom() ;

// Refresh data
document.querySelector('#refresh-button').addEventListener('click',function(e){
	removeItemsFromSessionStorage();
	window.location = window.location ;	
}) ;

</script>
</body>
</html>
